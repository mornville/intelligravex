{% extends "base.html" %}
{% block content %}
  <div class="row">
    <h1 style="margin: 0;">Conversation</h1>
    <span class="pill">bot: {{ bot.name }}</span>
    {% if conversation.test_flag %}<span class="pill">test</span>{% endif %}
    <div class="right"></div>
    <a class="pill" href="/bots/{{ bot.id }}/conversations">Back</a>
  </div>

  <div class="card" style="margin-top: 14px;">
    <div class="muted">UUID: <code>{{ conversation.id }}</code></div>
  </div>

  <div class="card" style="margin-top: 14px;">
    <h2>Metrics (est.)</h2>
    <div class="row" style="gap: 10px;">
      <span class="pill">input tokens: {{ conversation.llm_input_tokens_est or 0 }}</span>
      <span class="pill">output tokens: {{ conversation.llm_output_tokens_est or 0 }}</span>
      <span class="pill">cost: ${{ "%.6f"|format(conversation.cost_usd_est or 0.0) }}</span>
    </div>
    <div class="row" style="gap: 10px; margin-top: 10px;">
      <span class="pill">ASR: {% if conversation.last_asr_ms is not none %}{{ conversation.last_asr_ms }}ms{% else %}—{% endif %}</span>
      <span class="pill">LLM 1st token: {% if conversation.last_llm_ttfb_ms is not none %}{{ conversation.last_llm_ttfb_ms }}ms{% else %}—{% endif %}</span>
      <span class="pill">LLM total: {% if conversation.last_llm_total_ms is not none %}{{ conversation.last_llm_total_ms }}ms{% else %}—{% endif %}</span>
      <span class="pill">TTS 1st audio: {% if conversation.last_tts_first_audio_ms is not none %}{{ conversation.last_tts_first_audio_ms }}ms{% else %}—{% endif %}</span>
      <span class="pill">total: {% if conversation.last_total_ms is not none %}{{ conversation.last_total_ms }}ms{% else %}—{% endif %}</span>
    </div>
  </div>

  <div class="card" style="margin-top: 14px;">
    <h2>Messages</h2>
    {% for m in messages %}
      <div style="margin-top: 12px;">
        <div class="muted">{{ m.created_at }} — <span class="pill">{{ m.role }}</span></div>
        {% if m.input_tokens_est is not none or m.output_tokens_est is not none or m.cost_usd_est is not none or m.asr_ms is not none or m.llm_ttfb_ms is not none or m.llm_total_ms is not none or m.tts_first_audio_ms is not none or m.total_ms is not none %}
          <div class="row" style="gap: 8px; margin-top: 6px;">
            {% if m.input_tokens_est is not none %}<span class="pill">in: {{ m.input_tokens_est }}</span>{% endif %}
            {% if m.output_tokens_est is not none %}<span class="pill">out: {{ m.output_tokens_est }}</span>{% endif %}
            {% if m.cost_usd_est is not none %}<span class="pill">cost: ${{ "%.6f"|format(m.cost_usd_est or 0.0) }}</span>{% endif %}
            {% if m.asr_ms is not none %}<span class="pill">ASR: {{ m.asr_ms }}ms</span>{% endif %}
            {% if m.llm_ttfb_ms is not none %}<span class="pill">LLM 1st: {{ m.llm_ttfb_ms }}ms</span>{% endif %}
            {% if m.llm_total_ms is not none %}<span class="pill">LLM: {{ m.llm_total_ms }}ms</span>{% endif %}
            {% if m.tts_first_audio_ms is not none %}<span class="pill">TTS 1st: {{ m.tts_first_audio_ms }}ms</span>{% endif %}
            {% if m.total_ms is not none %}<span class="pill">total: {{ m.total_ms }}ms</span>{% endif %}
          </div>
        {% endif %}
        <pre style="white-space: pre-wrap; margin-top: 8px;">{{ m.content }}</pre>
      </div>
    {% endfor %}
    {% if not messages %}
      <div class="muted">No messages yet.</div>
    {% endif %}
  </div>
{% endblock %}
