{% extends "base.html" %}
{% block content %}
  <div class="row">
    <h1 style="margin: 0;">Conversation</h1>
    <span class="pill">bot: {{ bot.name }}</span>
    {% if conversation.test_flag %}<span class="pill">test</span>{% endif %}
    <div class="right"></div>
    <a class="pill" href="/bots/{{ bot.id }}/conversations">Back</a>
  </div>

  <div class="card" style="margin-top: 14px;">
    <div class="muted">UUID: <code>{{ conversation.id }}</code></div>
  </div>

  <div class="card" style="margin-top: 14px;">
    <details>
      <summary style="cursor:pointer;"><strong>Metrics</strong> <span class="muted">(click to expand)</span></summary>
      <div class="muted" style="margin-top: 10px;">Metadata</div>
      <pre style="white-space: pre-wrap; margin-top: 6px;">{{ conversation.metadata_json or "{}" }}</pre>
      <div class="row" style="gap: 10px; margin-top: 10px;">
        <span class="pill">input: {{ conversation.llm_input_tokens_est or 0 }}</span>
        <span class="pill">output: {{ conversation.llm_output_tokens_est or 0 }}</span>
        <span class="pill">cost: ${{ "%.6f"|format(conversation.cost_usd_est or 0.0) }}</span>
      </div>
      <div class="row" style="gap: 10px; margin-top: 10px;">
        <span class="pill">ASR: {% if conversation.last_asr_ms is not none %}{{ conversation.last_asr_ms }}ms{% else %}—{% endif %}</span>
        <span class="pill">LLM 1st: {% if conversation.last_llm_ttfb_ms is not none %}{{ conversation.last_llm_ttfb_ms }}ms{% else %}—{% endif %}</span>
        <span class="pill">LLM: {% if conversation.last_llm_total_ms is not none %}{{ conversation.last_llm_total_ms }}ms{% else %}—{% endif %}</span>
        <span class="pill">TTS 1st: {% if conversation.last_tts_first_audio_ms is not none %}{{ conversation.last_tts_first_audio_ms }}ms{% else %}—{% endif %}</span>
        <span class="pill">total: {% if conversation.last_total_ms is not none %}{{ conversation.last_total_ms }}ms{% else %}—{% endif %}</span>
      </div>
    </details>
  </div>

  <div class="card" style="margin-top: 14px;">
    <h2>Messages</h2>
    <div style="display:flex; flex-direction:column; gap:12px; margin-top: 10px;">
      {% for m in messages %}
        <div style="display:flex; flex-direction:column; gap:6px; align-items: {% if m.role == 'user' %}flex-end{% else %}flex-start{% endif %};">
          <div class="row" style="gap:8px;">
            <span class="pill">{{ m.role }}</span>
            {% if m.role == 'tool' and m.tool_name %}
              <span class="pill">{{ m.tool_name }}</span>
              {% if m.tool_kind %}<span class="pill">{{ m.tool_kind }}</span>{% endif %}
            {% endif %}
          </div>

          <div style="
              max-width: 92%;
              padding: 10px 12px;
              border: 1px solid rgba(120,150,220,0.20);
              border-radius: 14px;
              background: {% if m.role == 'user' %}rgba(124,135,255,0.10){% elif m.role == 'tool' %}rgba(155,209,255,0.06){% else %}rgba(12,16,28,0.55){% endif %};
              white-space: pre-wrap;
            ">{{ (m.display if m.display is defined and m.display) else m.content }}</div>

          <details style="max-width: 92%;">
            <summary class="muted" style="cursor:pointer;">details</summary>
            <div class="muted" style="margin-top:6px;">{{ m.created_at }}</div>
            {% set t = (m.metrics if m.metrics is defined and m.metrics) else {
              "in": m.input_tokens_est if m.input_tokens_est is defined else none,
              "out": m.output_tokens_est if m.output_tokens_est is defined else none,
              "cost": m.cost_usd_est if m.cost_usd_est is defined else none,
              "asr": m.asr_ms if m.asr_ms is defined else none,
              "llm1": m.llm_ttfb_ms if m.llm_ttfb_ms is defined else none,
              "llm": m.llm_total_ms if m.llm_total_ms is defined else none,
              "tts1": m.tts_first_audio_ms if m.tts_first_audio_ms is defined else none,
              "total": m.total_ms if m.total_ms is defined else none
            } %}
            {% if t.get("in") is not none or t.get("out") is not none or t.get("cost") is not none or t.get("asr") is not none or t.get("llm1") is not none or t.get("llm") is not none or t.get("tts1") is not none or t.get("total") is not none %}
              <div class="row" style="gap:8px; margin-top: 8px;">
                {% if t.get("in") is not none %}<span class="pill">in: {{ t.get("in") }}</span>{% endif %}
                {% if t.get("out") is not none %}<span class="pill">out: {{ t.get("out") }}</span>{% endif %}
                {% if t.get("cost") is not none %}<span class="pill">cost: ${{ "%.6f"|format(t.get("cost") or 0.0) }}</span>{% endif %}
                {% if t.get("asr") is not none %}<span class="pill">ASR: {{ t.get("asr") }}ms</span>{% endif %}
                {% if t.get("llm1") is not none %}<span class="pill">LLM 1st: {{ t.get("llm1") }}ms</span>{% endif %}
                {% if t.get("llm") is not none %}<span class="pill">LLM: {{ t.get("llm") }}ms</span>{% endif %}
                {% if t.get("tts1") is not none %}<span class="pill">TTS 1st: {{ t.get("tts1") }}ms</span>{% endif %}
                {% if t.get("total") is not none %}<span class="pill">total: {{ t.get("total") }}ms</span>{% endif %}
              </div>
            {% endif %}

            {% if m.role == 'tool' and m.tool %}
              <div class="muted" style="margin-top:10px;">raw</div>
              <pre style="white-space: pre-wrap; margin-top: 6px;">{{ m.content }}</pre>
            {% endif %}
          </details>
        </div>
      {% endfor %}
    </div>
    {% if not messages %}
      <div class="muted">No messages yet.</div>
    {% endif %}
  </div>
{% endblock %}
